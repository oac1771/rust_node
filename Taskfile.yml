version: '3'

tasks:
  start-local:
    cmds:
      - |
        task docker-build 
      - task: start-minikube
      - task: deploy-ecosystem
    env:
      BUILD: '{{ .BUILD }}'

  deploy-ecosystem:
    internal: true
    cmds:
      - helm install node-ecosystem helm_chart/

  start-minikube:
    internal: true
    cmds:
      - minikube start
    status:
      - minikube status

  docker-build:
    cmds:
      - docker build -f docker/rust_node_builder.Dockerfile . -t rust_node_builder:latest
      - |
        docker run --rm -it -v "$(pwd)":/rust_node rust_node_builder:latest \
          /bin/bash -c 'source "$HOME/.cargo/env" && cargo build --target x86_64-unknown-linux-musl --release'
      - docker build -f docker/rust_node.Dockerfile . -t rust_node:latest
    env:
      BUILD: true
    status:
      - |
        if [ "$BUILD" != "true" ]; then exit 0; else exit 1; fi
