version: '3'

tasks:
  start-local:
    cmds:
      - task: docker-build
      - task: start-minikube
      - task: deploy-ecosystem

  deploy-ecosystem:
    cmds:
      - echo hi

  start-minikube:
    internal: true
    cmds:
      - minikube start
    status:
      - minikube status

  docker-build:
    cmds:
      - docker build -f docker/rust_node_builder.Dockerfile . -t rust_node_builder:latest
      - |
        docker run --rm -it -v "$(pwd)":/rust_node rust_node_builder:latest \
          /bin/bash -c 'source "$HOME/.cargo/env" && cargo build --target x86_64-unknown-linux-musl --release'
      - docker build -f docker/rust_node.Dockerfile . -t rust_node:latest
